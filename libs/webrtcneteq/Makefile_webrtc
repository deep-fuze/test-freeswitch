BASE=../..
switch_srcdir := $(CURDIR)/../..
switch_builddir := $(CURDIR)/../..
GETLIB=cd $(switch_srcdir)/libs && $(SHELL) $(switch_builddir)/build/getlib.sh.in

WEBRTC=libwebrtccore.a
WEBRTC_DIR=$(switch_srcdir)/libs/webrtcneteq
WEBRTC_BUILDDIR=$(switch_builddir)/libs/webrtcneteq/src

WEBRTC_OBJ_DIR=$(WEBRTC_DIR)/libwebrtc/out/webrtc/src/out/Release/obj/webrtc

$(WEBRTC_DIR)/libwebrtc:
	git clone https://github.com/lsurazski/libwebrtc.git

$(WEBRTC_DIR)/libwebrtc/out:
	cd libwebrtc && mkdir out

.step1: $(WEBRTC_DIR)/libwebrtc $(WEBRTC_DIR)/libwebrtc/out
	cd libwebrtc/out && cmake -DGN_EXTRA_ARGS="cflags=-fPIC" ..
	touch .step1

.step2: .step1
	cd libwebrtc/out && make
	touch .step2

.installed_webrtc: .step2
	mv $(WEBRTC_OBJ_DIR)/common_audio/common_audio_c/cross_correlation.o $(WEBRTC_OBJ_DIR)/common_audio/common_audio_c/cross_correlation_2.o
	find $(WEBRTC_OBJ_DIR)/modules/audio_coding -name "*.o"	| xargs ar cru libwebrtccore.a
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/common_audio/common_audio_c/*.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/base/rtc_base_approved/checks.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/webrtc_common/common_types.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/modules/audio_coding/builtin_audio_decoder_factory_internal/builtin_audio_decoder_factory_internal.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/api/audio_codecs/builtin_audio_decoder_factory/builtin_audio_decoder_factory.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/api/audio_codecs/audio_codecs_api/*
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/base/rtc_base_approved/*.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/modules/audio_coding/neteq/*.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/system_wrappers/metrics_default/metrics_default.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/common_audio/common_audio_c/cross_correlation_2.o
	ar cru libwebrtccore.a $(WEBRTC_OBJ_DIR)/../third_party/libsrtp/libsrtp/srtp.o
	find $(WEBRTC_OBJ_DIR)/common_audio/ -name "*.o" | xargs ar cru libwebrtccore.a
	ranlib libwebrtccore.a
	touch .installed_webrtc

all: .installed_webrtc
